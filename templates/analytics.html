<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hattz Empire - Operations Analytics</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        .analytics-dashboard {
            padding: 24px;
            max-width: 1600px;
            margin: 0 auto;
            width: 100%;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .dashboard-header h1 {
            font-size: 24px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .back-link {
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: color 0.2s;
        }

        .back-link:hover {
            color: var(--accent-blue);
        }

        .controls {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .date-input {
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 13px;
        }

        .refresh-btn {
            padding: 8px 16px;
            background: var(--accent-blue);
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .refresh-btn:hover {
            background: #3a8eef;
        }

        /* Alerts Section */
        .alerts-section {
            margin-bottom: 24px;
        }

        .alert-item {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
        }

        .alert-item.critical {
            background: rgba(248, 81, 73, 0.15);
            border: 1px solid var(--accent-red);
            color: var(--accent-red);
        }

        .alert-item.warning {
            background: rgba(210, 153, 34, 0.15);
            border: 1px solid var(--accent-yellow);
            color: var(--accent-yellow);
        }

        .alert-icon {
            font-size: 18px;
        }

        .no-alerts {
            padding: 12px 16px;
            background: rgba(63, 185, 80, 0.1);
            border: 1px solid var(--accent-green);
            border-radius: 8px;
            color: var(--accent-green);
            font-size: 14px;
        }

        /* Summary Cards */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .summary-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
        }

        .summary-card .label {
            font-size: 12px;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .summary-card .value {
            font-size: 28px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .summary-card .value.cost {
            color: var(--accent-green);
        }

        .summary-card .value.warning {
            color: var(--accent-yellow);
        }

        .summary-card .value.danger {
            color: var(--accent-red);
        }

        .summary-card .sub {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        /* Chart Card */
        .chart-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .chart-card h3 {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Charts Grid */
        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }

        /* Data Table */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th,
        .data-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .data-table th {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .data-table td {
            color: var(--text-primary);
            font-size: 13px;
        }

        .data-table tbody tr:hover {
            background: var(--bg-tertiary);
        }

        .data-table .cost {
            color: var(--accent-green);
            font-weight: 500;
        }

        .data-table .success-high {
            color: var(--accent-green);
        }

        .data-table .success-mid {
            color: var(--accent-yellow);
        }

        .data-table .success-low {
            color: var(--accent-red);
        }

        /* Trend Chart */
        .trend-chart {
            display: flex;
            align-items: flex-end;
            gap: 8px;
            height: 100px;
            padding: 10px 0;
        }

        .trend-day {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .trend-bar {
            width: 100%;
            background: linear-gradient(180deg, var(--accent-blue), var(--accent-purple));
            border-radius: 4px 4px 0 0;
            min-height: 4px;
            transition: height 0.3s ease;
        }

        .trend-label {
            font-size: 10px;
            color: var(--text-tertiary);
        }

        .trend-value {
            font-size: 11px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* Loading State */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .loading::after {
            content: '';
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 1024px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            .summary-cards {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .dashboard-header {
                flex-direction: column;
                gap: 16px;
                align-items: flex-start;
            }
            .summary-cards {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body class="page-analytics">
    <div class="analytics-dashboard">
        <div class="dashboard-header">
            <div>
                <a href="/" class="back-link">‚Üê Back to Chat</a>
                <h1>
                    <span>üìä</span>
                    Operations Analytics
                </h1>
            </div>
            <div class="controls">
                <input type="date" id="report-date" class="date-input" />
                <button id="refresh-btn" class="refresh-btn">Refresh</button>
            </div>
        </div>

        <!-- Alerts Section -->
        <div class="alerts-section" id="alerts-section">
            <div class="loading">Loading alerts...</div>
        </div>

        <!-- Summary Cards -->
        <div class="summary-cards" id="summary-cards">
            <div class="summary-card">
                <div class="label">Total Cost</div>
                <div class="value cost" id="total-cost">-</div>
                <div class="sub">Daily limit: $5.00</div>
            </div>
            <div class="summary-card">
                <div class="label">Total Calls</div>
                <div class="value" id="total-calls">-</div>
                <div class="sub" id="tokens-info">-</div>
            </div>
            <div class="summary-card">
                <div class="label">Success Rate</div>
                <div class="value" id="success-rate">-</div>
                <div class="sub" id="error-count">-</div>
            </div>
            <div class="summary-card">
                <div class="label">Avg Latency</div>
                <div class="value" id="avg-latency">-</div>
                <div class="sub">Target: &lt;30s</div>
            </div>
        </div>

        <!-- Charts Grid -->
        <div class="charts-grid">
            <!-- By Agent -->
            <div class="chart-card">
                <h3>üë• Agent Performance</h3>
                <div id="agent-table-container">
                    <div class="loading">Loading...</div>
                </div>
            </div>

            <!-- By Model -->
            <div class="chart-card">
                <h3>ü§ñ Model Usage</h3>
                <div id="model-table-container">
                    <div class="loading">Loading...</div>
                </div>
            </div>
        </div>

        <!-- 7-Day Trends -->
        <div class="chart-card">
            <h3>üìà 7-Day Cost Trend</h3>
            <div id="trends-container">
                <div class="loading">Loading trends...</div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const dateInput = document.getElementById('report-date');
        const refreshBtn = document.getElementById('refresh-btn');

        // Set default date to yesterday
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        dateInput.value = yesterday.toISOString().split('T')[0];

        // Load initial data
        loadAlerts();
        loadDailyReport(dateInput.value);
        loadTrends();

        // Event listeners
        refreshBtn.addEventListener('click', () => {
            loadAlerts();
            loadDailyReport(dateInput.value);
            loadTrends();
        });

        dateInput.addEventListener('change', () => {
            loadDailyReport(dateInput.value);
        });
    });

    async function loadAlerts() {
        const container = document.getElementById('alerts-section');
        try {
            const res = await fetch('/api/analytics/alerts');
            const data = await res.json();

            if (data.alerts && data.alerts.length > 0) {
                container.innerHTML = data.alerts.map(alert => `
                    <div class="alert-item ${alert.severity}">
                        <span class="alert-icon">${alert.severity === 'critical' ? 'üö®' : '‚ö†Ô∏è'}</span>
                        <span>${alert.message}</span>
                    </div>
                `).join('');
            } else {
                container.innerHTML = '<div class="no-alerts">‚úÖ No active alerts - All systems normal</div>';
            }
        } catch (e) {
            container.innerHTML = '<div class="alert-item warning"><span class="alert-icon">‚ö†Ô∏è</span> Failed to load alerts</div>';
        }
    }

    async function loadDailyReport(date) {
        try {
            const res = await fetch(`/api/analytics/daily?date=${date}`);
            const data = await res.json();

            if (data.error) {
                console.error(data.error);
                return;
            }

            const s = data.summary;

            // Update summary cards
            const costEl = document.getElementById('total-cost');
            costEl.textContent = `$${s.total_cost_usd.toFixed(4)}`;
            costEl.className = 'value ' + (s.total_cost_usd > 5 ? 'danger' : s.total_cost_usd > 4 ? 'warning' : 'cost');

            document.getElementById('total-calls').textContent = s.total_calls.toLocaleString();
            document.getElementById('tokens-info').textContent = `${(s.total_input_tokens/1000).toFixed(1)}K in / ${(s.total_output_tokens/1000).toFixed(1)}K out`;

            const rateEl = document.getElementById('success-rate');
            rateEl.textContent = `${s.success_rate_pct}%`;
            rateEl.className = 'value ' + (s.success_rate_pct >= 80 ? 'cost' : s.success_rate_pct >= 50 ? 'warning' : 'danger');
            document.getElementById('error-count').textContent = `${s.error_count} errors`;

            const latencyEl = document.getElementById('avg-latency');
            const latencySec = s.avg_latency_ms / 1000;
            latencyEl.textContent = `${latencySec.toFixed(1)}s`;
            latencyEl.className = 'value ' + (latencySec <= 10 ? 'cost' : latencySec <= 30 ? 'warning' : 'danger');

            // Agent table
            const agentContainer = document.getElementById('agent-table-container');
            if (data.by_agent.length > 0) {
                agentContainer.innerHTML = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Agent</th>
                                <th>Calls</th>
                                <th>Cost</th>
                                <th>Success</th>
                                <th>Latency</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.by_agent.map(a => {
                                const successClass = a.success_rate_pct >= 80 ? 'success-high' : a.success_rate_pct >= 50 ? 'success-mid' : 'success-low';
                                return `
                                    <tr>
                                        <td><strong>${a.agent || '-'}</strong></td>
                                        <td>${a.calls}</td>
                                        <td class="cost">$${a.cost_usd.toFixed(4)}</td>
                                        <td class="${successClass}">${a.success_rate_pct}%</td>
                                        <td>${(a.avg_latency_ms/1000).toFixed(1)}s</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
            } else {
                agentContainer.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">No data for this date</p>';
            }

            // Model table
            const modelContainer = document.getElementById('model-table-container');
            if (data.by_model.length > 0) {
                modelContainer.innerHTML = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Model</th>
                                <th>Calls</th>
                                <th>Cost</th>
                                <th>Tokens</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.by_model.map(m => `
                                <tr>
                                    <td><strong>${m.model || '-'}</strong></td>
                                    <td>${m.calls}</td>
                                    <td class="cost">$${m.cost_usd.toFixed(4)}</td>
                                    <td>${((m.input_tokens + m.output_tokens)/1000).toFixed(1)}K</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } else {
                modelContainer.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">No data for this date</p>';
            }

        } catch (e) {
            console.error('Failed to load daily report:', e);
        }
    }

    async function loadTrends() {
        const container = document.getElementById('trends-container');
        try {
            const res = await fetch('/api/analytics/trends?days=7');
            const data = await res.json();

            if (data.daily && data.daily.length > 0) {
                const maxCost = Math.max(...data.daily.map(d => d.cost_usd), 0.01);

                container.innerHTML = `
                    <div class="trend-chart">
                        ${data.daily.map(day => {
                            const height = (day.cost_usd / maxCost) * 80;
                            const dateStr = day.date ? day.date.slice(5) : '-';
                            return `
                                <div class="trend-day">
                                    <div class="trend-value">$${day.cost_usd.toFixed(2)}</div>
                                    <div class="trend-bar" style="height: ${Math.max(height, 4)}px"></div>
                                    <div class="trend-label">${dateStr}</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    <div style="margin-top: 16px; font-size: 12px; color: var(--text-secondary);">
                        Day-over-day: Cost ${data.day_over_day.cost_change_pct > 0 ? '‚Üë' : '‚Üì'} ${Math.abs(data.day_over_day.cost_change_pct)}% |
                        Calls ${data.day_over_day.calls_change_pct > 0 ? '‚Üë' : '‚Üì'} ${Math.abs(data.day_over_day.calls_change_pct)}%
                    </div>
                `;
            } else {
                container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">No trend data available</p>';
            }
        } catch (e) {
            container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">Failed to load trends</p>';
        }
    }
    </script>
</body>
</html>
