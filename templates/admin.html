<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hattz Empire - Admin Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; }
        body {
            background: #0a0a0f;
            color: #e0e0e0;
            font-family: 'JetBrains Mono', monospace;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }

        .admin-wrapper {
            max-width: 1600px;
            margin: 0 auto;
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #2a2a3a;
        }

        .admin-header h1 {
            margin: 0;
            color: #00ff88;
            font-size: 1.5rem;
        }

        .admin-header a {
            color: #888;
            text-decoration: none;
            margin-left: 20px;
        }

        .admin-header a:hover { color: #00ff88; }

        /* Stats Row */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: #12121a;
            border: 1px solid #2a2a3a;
            border-radius: 8px;
            padding: 15px;
        }

        .stat-card h3 {
            margin: 0 0 8px 0;
            color: #888;
            font-size: 0.75rem;
            text-transform: uppercase;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 600;
            color: #00ff88;
        }

        .stat-value.warning { color: #ffaa00; }
        .stat-value.error { color: #ff4444; }
        .stat-sub { font-size: 0.75rem; color: #666; margin-top: 4px; }

        /* Tabs */
        .tab-nav {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            border-bottom: 1px solid #2a2a3a;
            padding-bottom: 10px;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 10px 20px;
            background: transparent;
            border: 1px solid #2a2a3a;
            border-radius: 6px 6px 0 0;
            color: #888;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .tab-btn:hover {
            background: #1a1a24;
            color: #00ff88;
        }

        .tab-btn.active {
            background: #00ff8822;
            border-color: #00ff88;
            color: #00ff88;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Section */
        .section {
            background: #12121a;
            border: 1px solid #2a2a3a;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .section h2 {
            margin: 0 0 15px 0;
            font-size: 1rem;
            color: #00ff88;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section h2 .badge {
            background: #00ff8833;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
        }

        /* Alerts */
        .alert {
            padding: 12px 15px;
            border-radius: 6px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert.critical {
            background: #ff444422;
            border: 1px solid #ff4444;
            color: #ff6b6b;
        }

        .alert.warning {
            background: #ffaa0022;
            border: 1px solid #ffaa00;
            color: #ffd93d;
        }

        .alert-icon { font-size: 1.2rem; }

        /* Grid layouts */
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        /* Data card */
        .data-card {
            background: #1a1a24;
            border: 1px solid #2a2a3a;
            border-radius: 6px;
            padding: 15px;
        }

        .data-card .label {
            font-size: 0.8rem;
            color: #888;
            margin-bottom: 5px;
        }

        .data-card .value {
            font-size: 1.3rem;
            font-weight: 600;
            color: #00ff88;
        }

        .data-card .value.warning { color: #ffaa00; }
        .data-card .value.error { color: #ff4444; }

        /* Table */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th, .data-table td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid #2a2a3a;
        }

        .data-table th {
            color: #888;
            font-size: 0.75rem;
            text-transform: uppercase;
            font-weight: 600;
        }

        .data-table td {
            font-size: 0.85rem;
        }

        .data-table tr:hover {
            background: #1a1a24;
        }

        /* Progress bar */
        .progress-bar {
            height: 8px;
            background: #2a2a3a;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #00ff88;
            transition: width 0.3s;
        }

        .progress-fill.warning { background: #ffaa00; }
        .progress-fill.error { background: #ff4444; }

        /* Process list */
        .process-item {
            background: #1a1a24;
            border: 1px solid #2a2a3a;
            border-radius: 6px;
            padding: 12px 15px;
            display: grid;
            grid-template-columns: 80px 1fr auto auto auto;
            gap: 15px;
            align-items: center;
            margin-bottom: 8px;
        }

        .process-item.current {
            border-color: #00ff8855;
            background: #00ff8811;
        }

        .process-pid { font-weight: 600; color: #00aaff; }
        .process-item.current .process-pid { color: #00ff88; }
        .process-cmd { color: #888; font-size: 0.8rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .process-memory { color: #ffd93d; font-size: 0.85rem; }
        .process-cpu { color: #6bcb77; font-size: 0.85rem; }

        .badge {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            text-transform: uppercase;
        }

        .badge.green { background: #00ff8833; color: #00ff88; }
        .badge.blue { background: #00aaff33; color: #00aaff; }
        .badge.gray { background: #88888833; color: #888; }

        /* Agent cards */
        .agent-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
        }

        .agent-card {
            background: #1a1a24;
            border: 1px solid #2a2a3a;
            border-radius: 6px;
            padding: 15px;
            text-align: center;
        }

        .agent-card.active { border-color: #00ff8855; }
        .agent-name { font-weight: 600; margin-bottom: 8px; text-transform: uppercase; font-size: 0.85rem; }
        .agent-count { font-size: 1.5rem; color: #00ff88; }
        .agent-count.idle { color: #555; }

        /* Chart placeholder */
        .chart-placeholder {
            height: 200px;
            background: #1a1a24;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #555;
        }

        .empty-state {
            text-align: center;
            color: #555;
            padding: 30px;
        }

        .refresh-info {
            color: #555;
            font-size: 0.75rem;
        }
    </style>
</head>
<body>
    <div class="admin-wrapper">
        <div class="admin-header">
            <h1>Admin Dashboard</h1>
            <div>
                <span class="refresh-info">Auto refresh: 5s</span>
                <a href="/chat">Chat</a>
            </div>
        </div>

        <!-- Top Stats -->
        <div class="stats-row">
            <div class="stat-card">
                <h3>Today Cost</h3>
                <div class="stat-value" id="today-cost">$0.00</div>
                <div class="stat-sub" id="cost-limit">/ $5.00 limit</div>
            </div>
            <div class="stat-card">
                <h3>Today Calls</h3>
                <div class="stat-value" id="today-calls">0</div>
                <div class="stat-sub" id="success-rate">0% success</div>
            </div>
            <div class="stat-card">
                <h3>Active Tasks</h3>
                <div class="stat-value" id="active-tasks">0</div>
            </div>
            <div class="stat-card">
                <h3>CLI Queue</h3>
                <div class="stat-value" id="cli-queue">0</div>
            </div>
            <div class="stat-card">
                <h3>Embedding Queue</h3>
                <div class="stat-value" id="embedding-queue">0</div>
            </div>
        </div>

        <!-- Alerts -->
        <div id="alerts-container"></div>

        <!-- Tabs -->
        <div class="tab-nav">
            <button class="tab-btn active" onclick="switchTab('costs')">Costs</button>
            <button class="tab-btn" onclick="switchTab('agents')">Agents</button>
            <button class="tab-btn" onclick="switchTab('cli')">CLI Queue</button>
            <button class="tab-btn" onclick="switchTab('processes')">Processes</button>
        </div>

        <!-- Costs Tab -->
        <div id="tab-costs" class="tab-content active">
            <div class="grid-2">
                <div class="section">
                    <h2>Cost by Model</h2>
                    <table class="data-table" id="model-table">
                        <thead>
                            <tr><th>Model</th><th>Calls</th><th>Cost</th><th>Share</th></tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="section">
                    <h2>Cost by Agent</h2>
                    <table class="data-table" id="agent-table">
                        <thead>
                            <tr><th>Agent</th><th>Calls</th><th>Cost</th><th>Success</th></tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            <div class="section">
                <h2>Daily Trend (7 days)</h2>
                <table class="data-table" id="daily-table">
                    <thead>
                        <tr><th>Date</th><th>Calls</th><th>Cost</th><th>Success Rate</th><th>Avg Latency</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Agents Tab -->
        <div id="tab-agents" class="tab-content">
            <div class="section">
                <h2>Agent Status</h2>
                <div class="agent-grid" id="agent-grid"></div>
            </div>
            <div class="section">
                <h2>Running Tasks <span class="badge" id="running-count">0</span></h2>
                <div id="running-tasks"><div class="empty-state">No running tasks</div></div>
            </div>
            <div class="section">
                <h2>Recent Completed <span class="badge" id="completed-count">0</span></h2>
                <div id="completed-tasks"><div class="empty-state">No completed tasks</div></div>
            </div>
        </div>

        <!-- CLI Queue Tab -->
        <div id="tab-cli" class="tab-content">
            <div class="section">
                <h2>CLI Queue Status</h2>
                <div class="grid-3">
                    <div class="data-card">
                        <div class="label">Queue Size</div>
                        <div class="value" id="cli-queue-size">0</div>
                    </div>
                    <div class="data-card">
                        <div class="label">Active Processes</div>
                        <div class="value" id="cli-active">0</div>
                    </div>
                    <div class="data-card">
                        <div class="label">Rate Limit Available</div>
                        <div class="value" id="cli-rate-limit">-</div>
                    </div>
                    <div class="data-card">
                        <div class="label">Max Concurrent</div>
                        <div class="value" id="cli-max-concurrent">-</div>
                    </div>
                    <div class="data-card">
                        <div class="label">Queue Healthy</div>
                        <div class="value" id="cli-health-queue">-</div>
                    </div>
                    <div class="data-card">
                        <div class="label">No Zombies</div>
                        <div class="value" id="cli-health-zombie">-</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Processes Tab -->
        <div id="tab-processes" class="tab-content">
            <div class="section">
                <h2>Python Processes <span class="badge" id="process-count">0</span></h2>
                <div style="margin-bottom: 15px; font-size: 0.85rem;">
                    Current Flask PID: <strong id="current-pid">-</strong> |
                    Flask Processes: <strong id="flask-count">-</strong>
                    <span id="flask-warning" style="color: #ff6b6b; display: none;"> (Multiple Flask instances!)</span>
                </div>
                <div id="process-list"></div>
            </div>
        </div>
    </div>

    <script>
        const AGENTS = ['pm', 'coder', 'qa', 'researcher', 'strategist', 'analyst'];

        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }

        function formatCost(cost) {
            return '$' + (cost || 0).toFixed(4);
        }

        // Fetch all data
        async function updateDashboard() {
            try {
                // Parallel fetch - analytics 사용 (agent_logs 테이블)
                const [monitorRes, analyticsRes, trendsRes, embeddingRes] = await Promise.all([
                    fetch('/api/monitor/dashboard'),
                    fetch('/api/analytics/daily?date=' + new Date().toISOString().split('T')[0]),
                    fetch('/api/analytics/trends?days=7'),
                    fetch('/api/health/embedding-queue')
                ]);

                const monitor = await monitorRes.json();
                const analytics = await analyticsRes.json();
                const trends = await trendsRes.json();
                const embedding = await embeddingRes.json();

                // Top stats
                const summary = analytics.summary || {};
                document.getElementById('today-cost').textContent = formatCost(summary.total_cost_usd);
                document.getElementById('today-cost').className = 'stat-value' +
                    (summary.total_cost_usd > 5 ? ' error' : summary.total_cost_usd > 4 ? ' warning' : '');
                document.getElementById('today-calls').textContent = summary.total_calls || 0;
                document.getElementById('success-rate').textContent = (summary.success_rate_pct || 0) + '% success';

                document.getElementById('active-tasks').textContent = monitor.active_count || 0;

                const cli = monitor.cli || {};
                const queue = cli.queue || {};
                document.getElementById('cli-queue').textContent = queue.queue_size || 0;
                document.getElementById('embedding-queue').textContent = embedding.pending || 0;

                // Alerts
                const alertsHtml = (analytics.alerts || []).map(a => `
                    <div class="alert ${a.severity}">
                        <span class="alert-icon">${a.severity === 'critical' ? '!!' : '!'}</span>
                        <span>${a.message}</span>
                    </div>
                `).join('');
                document.getElementById('alerts-container').innerHTML = alertsHtml;

                // Model table (from analytics.by_model)
                const modelBody = document.querySelector('#model-table tbody');
                const byModel = analytics.by_model || [];
                const totalModelCost = byModel.reduce((s, m) => s + (m.cost_usd || 0), 0);
                modelBody.innerHTML = byModel.slice(0, 10).map(m => `
                    <tr>
                        <td>${m.model || '-'}</td>
                        <td>${m.calls || 0}</td>
                        <td>${formatCost(m.cost_usd)}</td>
                        <td>${totalModelCost > 0 ? ((m.cost_usd / totalModelCost) * 100).toFixed(1) : 0}%</td>
                    </tr>
                `).join('') || '<tr><td colspan="4" class="empty-state">No data</td></tr>';

                // Agent table (from analytics.by_agent)
                const agentBody = document.querySelector('#agent-table tbody');
                agentBody.innerHTML = (analytics.by_agent || []).slice(0, 10).map(a => `
                    <tr>
                        <td>${a.agent || '-'}</td>
                        <td>${a.calls || 0}</td>
                        <td>${formatCost(a.cost_usd)}</td>
                        <td>${a.success_rate_pct || 0}%</td>
                    </tr>
                `).join('') || '<tr><td colspan="4" class="empty-state">No data</td></tr>';

                // Daily table (from trends.daily)
                const dailyBody = document.querySelector('#daily-table tbody');
                const daily = trends.daily || [];
                dailyBody.innerHTML = daily.slice().reverse().map(d => `
                    <tr>
                        <td>${d.date || '-'}</td>
                        <td>${d.calls || 0}</td>
                        <td>${formatCost(d.cost_usd)}</td>
                        <td>${d.success_rate_pct ? d.success_rate_pct.toFixed(1) : '-'}%</td>
                        <td>${d.avg_latency_ms ? (d.avg_latency_ms / 1000).toFixed(1) + 's' : '-'}</td>
                    </tr>
                `).join('') || '<tr><td colspan="5" class="empty-state">No data</td></tr>';

                // Agent grid
                document.getElementById('agent-grid').innerHTML = AGENTS.map(agent => {
                    const count = monitor.agents_summary?.[agent] || 0;
                    return `
                        <div class="agent-card ${count > 0 ? 'active' : ''}">
                            <div class="agent-name">${agent.toUpperCase()}</div>
                            <div class="agent-count ${count > 0 ? '' : 'idle'}">${count}</div>
                        </div>
                    `;
                }).join('');

                // Running tasks
                const runningTasks = monitor.active_tasks || [];
                document.getElementById('running-count').textContent = runningTasks.length;
                document.getElementById('running-tasks').innerHTML = runningTasks.length > 0 ?
                    runningTasks.map(t => `<div class="data-card"><strong>${t.agent}</strong>: ${t.description || '-'}</div>`).join('') :
                    '<div class="empty-state">No running tasks</div>';

                // Completed tasks
                const completedTasks = monitor.recent_completed || [];
                document.getElementById('completed-count').textContent = completedTasks.length;
                document.getElementById('completed-tasks').innerHTML = completedTasks.length > 0 ?
                    completedTasks.slice(0, 5).map(t => `<div class="data-card"><strong>${t.agent}</strong>: ${t.description || '-'} <span class="badge ${t.status === 'success' ? 'green' : 'gray'}">${t.status}</span></div>`).join('') :
                    '<div class="empty-state">No completed tasks</div>';

                // CLI Queue
                const health = cli.health || {};
                document.getElementById('cli-queue-size').textContent = queue.queue_size || 0;
                document.getElementById('cli-active').textContent = cli.processes?.active_count || 0;
                document.getElementById('cli-rate-limit').textContent = queue.rate_limiter?.available || '-';
                document.getElementById('cli-max-concurrent').textContent = cli.config?.max_concurrent || '-';
                document.getElementById('cli-health-queue').textContent = health.queue_healthy ? 'OK' : 'FULL';
                document.getElementById('cli-health-queue').className = 'value' + (health.queue_healthy ? '' : ' error');
                document.getElementById('cli-health-zombie').textContent = health.no_zombies ? 'OK' : 'ZOMBIES';
                document.getElementById('cli-health-zombie').className = 'value' + (health.no_zombies ? '' : ' error');

            } catch (err) {
                console.error('Dashboard update failed:', err);
            }
        }

        async function updateProcesses() {
            try {
                const res = await fetch('/api/monitor/processes');
                const data = await res.json();

                document.getElementById('process-count').textContent = data.total_count || 0;
                document.getElementById('current-pid').textContent = data.current_pid || '-';
                document.getElementById('flask-count').textContent = data.flask_count || 0;
                document.getElementById('flask-warning').style.display = data.flask_count > 1 ? 'inline' : 'none';

                const processes = data.python_processes || [];
                document.getElementById('process-list').innerHTML = processes.length > 0 ?
                    processes.map(p => `
                        <div class="process-item ${p.is_current ? 'current' : ''}">
                            <span class="process-pid">PID ${p.pid}</span>
                            <span class="process-cmd" title="${p.cmdline}">${p.cmdline || p.name}</span>
                            <span class="process-memory">${p.memory_mb} MB</span>
                            <span class="process-cpu">${p.cpu_percent.toFixed(1)}%</span>
                            <span class="badge ${p.is_current ? 'green' : p.is_flask ? 'blue' : 'gray'}">${p.is_current ? 'Current' : p.is_flask ? 'Flask' : 'Python'}</span>
                        </div>
                    `).join('') :
                    '<div class="empty-state">No Python processes</div>';
            } catch (err) {
                console.error('Process update failed:', err);
            }
        }

        // Initial load
        updateDashboard();
        updateProcesses();

        // Auto refresh
        setInterval(updateDashboard, 5000);
        setInterval(updateProcesses, 10000);
    </script>
</body>
</html>
