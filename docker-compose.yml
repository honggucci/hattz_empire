# Hattz Empire v2.2.4 - Docker Compose (Workers Only)
# Flask/ngrok은 로컬에서 실행, Claude CLI 워커들만 Docker로 실행
#
# 핵심 설계:
# 1. Flask는 로컬에서 실행 (python app.py)
# 2. ngrok도 로컬에서 실행 (ngrok http 5000 --domain=...)
# 3. Claude CLI 워커들만 Docker로 실행
# 4. 워커들은 host.docker.internal:5000으로 로컬 Flask에 접근
# 5. ANTHROPIC_API_KEY="" = 구독(Pro/Max)으로 CLI 실행
#
# 실행: docker-compose up -d
# 종료: docker-compose down
# 로그: docker-compose logs -f [service]

name: hattz-empire-v2-2

volumes:
  claude_state:   # /root/.claude-state 영속화 (로그인/세션)

networks:
  hattz:
    driver: bridge

# x-common: 공통 설정 (YAML 앵커)
x-claude-common: &claude-common
  build:
    context: .
    dockerfile: docker/Dockerfile.claude
  env_file: .env
  networks: [hattz]
  restart: unless-stopped
  extra_hosts:
    - "host.docker.internal:host-gateway"  # 로컬 Flask 접근용

x-api-common: &api-common
  build:
    context: .
    dockerfile: docker/Dockerfile.api
  env_file: .env
  networks: [hattz]
  restart: unless-stopped
  extra_hosts:
    - "host.docker.internal:host-gateway"

services:
  # ===========================================================================
  # PM LAYER
  # PM-Worker: OpenAI API (GPT-5.2 Thinking)
  # PM-Reviewer: Claude CLI (Skeptic)
  # ===========================================================================
  pm-worker:
    <<: *api-common
    container_name: hattz_pm_worker
    environment:
      - ROLE=pm
      - MODE=worker
      - LLM=gpt-5.2-thinking
      - PERSONA=strategist
      - WEB_BASE_URL=http://host.docker.internal:5000
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    volumes:
      - ./:/app:ro

  pm-reviewer:
    <<: *claude-common
    container_name: hattz_pm_reviewer
    environment:
      - ROLE=pm
      - MODE=reviewer
      - LLM=claude-cli
      - PERSONA=skeptic
      - SUBAGENT=pm-reviewer
      - WEB_BASE_URL=http://host.docker.internal:5000
      - ANTHROPIC_API_KEY=
    volumes:
      - ./:/app:ro
      - ./.claude:/root/.claude:rw
      - claude_state:/root/.claude-state:rw

  # ===========================================================================
  # CODER LAYER
  # Coder-Worker: Claude CLI (Implementer) - repo 전체 RW
  # Coder-Reviewer: Claude CLI (Devil's Advocate) - RO
  # ===========================================================================
  coder-worker:
    <<: *claude-common
    container_name: hattz_coder_worker
    environment:
      - ROLE=coder
      - MODE=worker
      - LLM=claude-cli
      - PERSONA=implementer
      - SUBAGENT=coder-worker
      - WEB_BASE_URL=http://host.docker.internal:5000
      - ANTHROPIC_API_KEY=
    volumes:
      - ./:/app:rw  # 유일하게 전체 RW
      - ./.claude:/root/.claude:rw
      - claude_state:/root/.claude-state:rw

  coder-reviewer:
    <<: *claude-common
    container_name: hattz_coder_reviewer
    environment:
      - ROLE=coder
      - MODE=reviewer
      - LLM=claude-cli
      - PERSONA=devils_advocate
      - SUBAGENT=coder-reviewer
      - WEB_BASE_URL=http://host.docker.internal:5000
      - ANTHROPIC_API_KEY=
    volumes:
      - ./:/app:ro
      - ./.claude:/root/.claude:rw
      - claude_state:/root/.claude-state:rw

  # ===========================================================================
  # QA LAYER
  # QA-Worker: Claude CLI (Tester) - tests/ 만 RW
  # QA-Reviewer: Claude CLI (Breaker) - RO
  # ===========================================================================
  qa-worker:
    <<: *claude-common
    container_name: hattz_qa_worker
    environment:
      - ROLE=qa
      - MODE=worker
      - LLM=claude-cli
      - PERSONA=tester
      - SUBAGENT=qa-worker
      - WEB_BASE_URL=http://host.docker.internal:5000
      - ANTHROPIC_API_KEY=
    volumes:
      - ./:/app:ro
      - ./tests:/app/tests:rw  # tests만 쓰기 가능
      - ./.claude:/root/.claude:rw
      - claude_state:/root/.claude-state:rw

  qa-reviewer:
    <<: *claude-common
    container_name: hattz_qa_reviewer
    environment:
      - ROLE=qa
      - MODE=reviewer
      - LLM=claude-cli
      - PERSONA=breaker
      - SUBAGENT=qa-reviewer
      - WEB_BASE_URL=http://host.docker.internal:5000
      - ANTHROPIC_API_KEY=
    volumes:
      - ./:/app:ro
      - ./.claude:/root/.claude:rw
      - claude_state:/root/.claude-state:rw

  # ===========================================================================
  # REVIEWER LAYER
  # Reviewer-Worker: Gemini API (Pragmatist) - RO
  # Reviewer-Reviewer: Claude CLI (Security Hawk) - RO
  # ===========================================================================
  reviewer-worker:
    <<: *api-common
    container_name: hattz_reviewer_worker
    environment:
      - ROLE=reviewer
      - MODE=worker
      - LLM=gemini-2.5-flash
      - PERSONA=pragmatist
      - WEB_BASE_URL=http://host.docker.internal:5000
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
    volumes:
      - ./:/app:ro

  reviewer-reviewer:
    <<: *claude-common
    container_name: hattz_reviewer_reviewer
    environment:
      - ROLE=reviewer
      - MODE=reviewer
      - LLM=claude-cli
      - PERSONA=security_hawk
      - SUBAGENT=security-hawk
      - WEB_BASE_URL=http://host.docker.internal:5000
      - ANTHROPIC_API_KEY=
    volumes:
      - ./:/app:ro
      - ./.claude:/root/.claude:rw
      - claude_state:/root/.claude-state:rw

  # ===========================================================================
  # MONITORING LAYER
  # Prometheus + Grafana (All-in-One)
  # ===========================================================================
  monitor:
    build:
      context: .
      dockerfile: docker/Dockerfile.monitor
    container_name: hattz_monitor
    networks: [hattz]
    restart: unless-stopped
    ports:
      - "9090:9090"   # Prometheus
      - "3000:3000"   # Grafana
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=hattz123
    volumes:
      - ./docker/prometheus:/etc/prometheus:ro
      - ./docker/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./docker/grafana/dashboards:/var/lib/grafana/dashboards:ro